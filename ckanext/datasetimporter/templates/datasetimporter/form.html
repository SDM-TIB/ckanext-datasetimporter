{% extends "page.html" %}

{% block page_primary_action %}
<h1 class="heading">Dataset Importer</h1>

<p class="lead">
  This form allows you to upload a folder of JSON files, choose an organization, a prefix for your dataset collection, and specify a repository name. 
  Once submitted, the datasets will be processed and indexed automatically.
</p>

<div class="panel panel-default">
  <div class="panel-body">

    <form method="post" enctype="multipart/form-data" class="form-horizontal">

      <!-- Step 1 -->
      <div class="form-group">
        <label class="control-label col-sm-2">Step 1</label>
        <div class="col-sm-10">
          <label><strong>üì¶ Upload your ZIP file containing JSONs</strong></label>
          <input type="file" name="folder" class="form-control" accept=".zip" required>
          <p class="help-block">Please compress your JSON files into a .zip file before uploading.</p>
        </div>
      </div>

      <!-- Step 2 -->
      <div class="form-group">
        <label class="control-label col-sm-2">Step 2</label>
        <div class="col-sm-10">
          <label><strong>Select your organization</strong></label>
          <select name="organization" class="form-control" required>
            <option value="">-- Please choose --</option>
            {% for org in orgs %}
              <option value="{{ org.id }}">{{ org.title or org.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <!-- Step 3 -->
      <div class="form-group">
        <label class="control-label col-sm-2">Step 3</label>
        <div class="col-sm-10">
          <label><strong>Dataset Name Prefix</strong></label>
          <input type="text" name="prefix" class="form-control" placeholder="e.g. myproject_" required>
          <p class="help-block">Give your dataset collection a prefix.</p>
        </div>
      </div>
      
      <!-- Step 4 -->
      <div class="form-group">
        <label class="control-label col-sm-2">Step 3</label>
        <div class="col-sm-10">
          <label><strong>Repository name</strong></label>
          <input type="text" name="repo_name" class="form-control" placeholder="e.g. Eurostat - Employment" required>
          <p class="help-block">Give your dataset collection a meaningful name.</p>
        </div>
      </div>

      <!-- Submit -->
      <div class="form-group">
        <div class="col-sm-offset-2 col-sm-10">
          <button type="submit" class="btn btn-primary btn-lg">Submit and Start Import</button>
        </div>
      </div>

    </form>

    <!-- Live Status -->
    <div id="status-box" class="alert alert-info" style="margin-top: 20px;"></div>
  </div>
</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const taskId = urlParams.get("task");

  if (taskId) {
    const box = document.getElementById("status-box");
    box.innerHTML = "‚è≥ Upload submitted. Please wait...";

    const interval = setInterval(() => {
      fetch(`/datasetimporter/status?task=${taskId}`)
        .then(res => res.text())
        .then(text => {
          box.innerHTML = text;
          if (text.includes("‚úÖ Done") || text.includes("‚ùå Error")) {
            box.className = text.includes("‚úÖ Done") ? "alert alert-success" : "alert alert-danger";
            clearInterval(interval);
          }
        });
    }, 2000);
  }
</script>
{% endblock %}
